---
title: "zls explore"
output: html_notebook
---

Some exploritory analysis of a subset of the data

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo = FALSE)
knitr::opts_knit$set(root.dir = "..")

## Load the necessary packages
library(tidyverse)
library(sf)
library(GGally)
library(lme4)
```

First chunk creates a subset of the full dataset to speed things up. Still dealing with 40000 records here so it aint nothing. Then we'll read back in that subset and work from there  

```{r, eval = F}
## Read in full shp
d = read_sf("local/grid_90_clean/grid_90_clean.shp")

seed(2020)

## subset for building
d2 = group_by(d, FIRE_NA) %>%
  slice_sample(n = 1000)

## Save, clear and read back in
write_sf(d2, "InProcessData/clean_sub.shp")

rm(d, d2)
```

```{r}
## Read in subset of clean data
shp = read_sf("InProcessData/clean_sub.shp")
```

```{r}
## Also make an aspatial version and drop some columns not of immediate interest
d = st_drop_geometry(shp) %>% 
  rename_all(tolower) %>% 
  dplyr::select(grid_id, fire_na, ecrgn_s, tslf:covrtyp, evt_phy, cwhr_gp,
                dnbr:rdnbr_h, bi:fm1000, ads_mort = m__12_1)

summary(d)
```

The underlying things we are interested in are the effects of fuels and weather/climate on fire severity. Let's look at related variables correlate.  

```{r}
## Fuels first
dplyr::select(d, tslf, mcc_fri, ads_mort) %>% 
  ggpairs()

## Then weather
dplyr::select(d, bi:fm1000) %>% 
  ggpairs()
```

Not high correlations among the fuels variables. Somewhat different story with the weather variables. erc, fm100 and fm1000 are highly correlated. rhmin and rhmax are moderately correlated with these as well (and highly with each other). bi shows moderte correlation with these as well. windspd and vpd are largely independent of everything else.

My guess is that tslf will be most useful among the fuels variables with ads_mort perhaps playing a role. When talking with Dereke and Hugh will have to decide on fuel condition variables.  

Lets do some quick and dirty modeling to get an idea of relationships with burn severity.  

```{r}
## Scale variables (some we may want to transfor first (e.g., ads_mort))
scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = na.rm))
ds = mutate_at(d, .vars = c('tslf', 'ads_mort', 'bi'), 
               function(x) log(x + 0.01)) %>% 
  mutate_at(.vars = c('tslf', 'mcc_fri', 'bi', 'windspd', 'vpd', 'rhmax', 'rhmin', 'erc', 'fm100', 'fm1000', 'ads_mort'), scale2)
```

```{r, eval = F}
## Fuel variables
mf = glmer(rdnbr_h ~ tslf + ads_mort + (1|fire_na), family = binomial,
         data = ds)

## Lets pull out some prominent veg types
table(d$cwhr_gp)

mf_ypmc = filter(ds, cwhr_gp %in% c("Yellow pine", "Mixed conifer")) %>% 
  glmer(rdnbr_h ~ tslf + ads_mort + (1|fire_na), 
        family = binomial, data = .)

mf_fir = filter(ds, cwhr_gp %in% c("White fir", "Red fir")) %>% 
  glmer(rdnbr_h ~ tslf + ads_mort + (1|fire_na), 
        family = binomial, data = .)

mf_lchap = filter(ds, cwhr_gp %in% c("Lowland chaparral")) %>% 
  glmer(rdnbr_h ~ tslf + ads_mort + (1|fire_na), 
        family = binomial, data = .)

mf_mchap = filter(ds, cwhr_gp %in% c("Montane chaparral")) %>% 
  glmer(rdnbr_h ~ tslf + ads_mort + (1|fire_na), 
        family = binomial, data = .)
```

Likelihood of burning at high-severity appears to increase with TSLF for ypmc, the firs and even lowland chaparral. Maybe the opposite for montane chaparral but uncertain. ads mortlity was positively correlated with ypmc but unrelated to the others. No big surprises here.  

```{r, eval= F}
## Weather variables
mw = glmer(rdnbr_h ~ windspd + vpd + rhmin + bi + (1|fire_na),
           family = binomial, data = ds)

mw_ypmc = filter(ds, cwhr_gp %in% c("Yellow pine", "Mixed conifer")) %>% 
  glmer(rdnbr_h ~ windspd + vpd + rhmin + bi + (1|fire_na),
           family = binomial, data = .)

mw_fir = filter(ds, cwhr_gp %in% c("White fir", "Red fir")) %>% 
  glmer(rdnbr_h ~ windspd + vpd + rhmin + bi + (1|fire_na),
           family = binomial, data = .)

mw_lchap = filter(ds, cwhr_gp %in% c("Lowland chaparral")) %>% 
  glmer(rdnbr_h ~ windspd + vpd + rhmin + bi + (1|fire_na),
           family = binomial, data = .)

mw_mchap = filter(ds, cwhr_gp %in% c("Montane chaparral")) %>% 
  glmer(rdnbr_h ~ windspd + vpd + rhmin + bi + (1|fire_na),
           family = binomial, data = .)

```

vpd appears universally important. windspd and bi also for some veg types.  

Let's put some things together.  

```{r}
ypmc = filter(ds, cwhr_gp %in% c("Yellow pine", "Mixed conifer"))
rf = filter(ds, cwhr_gp %in% c("Red fir"))
m_ypmc =  glmer(rdnbr_h ~ tslf + ads_mort +
                  windspd + vpd + bi + (1|fire_na),
                family = binomial, data = ypmc)
summary(m_ypmc)

library(brms)

m_rf = glmer(rdnbr_h ~ tslf + vpd + (1|fire_na),
             family = binomial,
             data = rf)

bm_rf = brm(rdnbr_h ~ (tslf + vpd) + (1|fire_na),
              family = bernoulli("logit"), 
              data = rf)
```

